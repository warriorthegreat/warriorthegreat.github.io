<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange Rate Optimizer | Alvin's Tools</title>
    
    <!-- 1. 引入 React 核心庫 (CDN) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- 2. 引入 Babel (讓瀏覽器看不懂 JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. 引入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 4. 引入 Phosphor Icons (圖標) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            background-color: #f8fafc;
        }
        /* 自定義捲軸樣式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <!-- 返回首頁按鈕 (固定在左上角) -->
    <a href="index.html" class="fixed top-4 left-4 z-50 flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-md hover:bg-slate-50 text-slate-700 font-bold transition-all text-sm no-underline border border-slate-200 group">
        <i class="ph-bold ph-arrow-left group-hover:-translate-x-1 transition-transform"></i>
        Back to Portfolio
    </a>

    <!-- React 應用程式掛載點 -->
    <div id="root"></div>

    <!-- React 程式邏輯 -->
    <script type="text/babel">
        const { useState, useEffect } = React;

        // 支援的貨幣列表
        const CURRENCIES = [
            { code: 'USD', name: '美元' },
            { code: 'HKD', name: '港幣' },
            { code: 'TWD', name: '台幣' },
            { code: 'JPY', name: '日圓' }
        ];

        function App() {
            // 匯率狀態
            const [rates, setRates] = useState({
                'USD-HKD': 7.78,
                'USD-TWD': 32.50,
                'USD-JPY': 154.20,
                'HKD-TWD': 4.18,
                'HKD-JPY': 19.82,
                'TWD-JPY': 4.74
            });

            const [amount, setAmount] = useState(1000);
            const [sourceCurr, setSourceCurr] = useState('USD'); 
            const [targetCurr, setTargetCurr] = useState('JPY');
            const [fee, setFee] = useState(0);
            
            const [isLoading, setIsLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [apiError, setApiError] = useState(null);

            // 取得兩貨幣間的匯率
            const getRate = (from, to, currentRates = rates) => {
                if (from === to) return 1;
                
                const key1 = `${from}-${to}`;
                const key2 = `${to}-${from}`;

                if (currentRates[key1] !== undefined) {
                    return currentRates[key1];
                } else if (currentRates[key2] !== undefined) {
                    return 1 / currentRates[key2];
                }
                return 0; 
            };

            // API 串接 (ExchangeRate-API)
            const fetchLiveRates = async () => {
                setIsLoading(true);
                setApiError(null);
                try {
                    const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                    const data = await response.json();

                    if (data && data.rates) {
                        const r = data.rates;
                        setRates({
                            'USD-HKD': parseFloat(r.HKD.toFixed(4)),
                            'USD-TWD': parseFloat(r.TWD.toFixed(4)),
                            'USD-JPY': parseFloat(r.JPY.toFixed(4)),
                            'HKD-TWD': parseFloat((r.TWD / r.HKD).toFixed(4)),
                            'HKD-JPY': parseFloat((r.JPY / r.HKD).toFixed(4)),
                            'TWD-JPY': parseFloat((r.JPY / r.TWD).toFixed(4))
                        });
                        
                        const now = new Date();
                        setLastUpdated(now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }));
                    }
                } catch (err) {
                    setApiError("無法連接至 ExchangeRate-API");
                    console.error(err);
                } finally {
                    setIsLoading(false);
                }
            };

            // 首次載入時自動抓取
            useEffect(() => {
                fetchLiveRates();
            }, []);

            const handleRateChange = (key, value) => {
                setRates(prev => ({
                    ...prev,
                    [key]: parseFloat(value) || 0
                }));
            };

            // 計算邏輯
            const calculateRoutes = () => {
                const results = [];
                const feeMultiplier = (100 - fee) / 100;

                // 1. 直接路徑
                const directRate = getRate(sourceCurr, targetCurr);
                results.push({
                    type: 'Direct',
                    path: [sourceCurr, targetCurr],
                    rate: directRate,
                    finalAmount: amount * directRate * feeMultiplier,
                    feeCount: 1
                });

                // 2. 間接路徑
                const intermediaries = CURRENCIES.filter(c => c.code !== sourceCurr && c.code !== targetCurr);
                
                intermediaries.forEach(mid => {
                    const rate1 = getRate(sourceCurr, mid.code);
                    const rate2 = getRate(mid.code, targetCurr);
                    const combinedRate = rate1 * rate2;
                    
                    results.push({
                        type: 'Indirect',
                        via: mid.name,
                        path: [sourceCurr, mid.code, targetCurr],
                        rate: combinedRate,
                        finalAmount: amount * rate1 * feeMultiplier * rate2 * feeMultiplier,
                        feeCount: 2
                    });
                });

                return results.sort((a, b) => b.finalAmount - a.finalAmount);
            };

            const routes = calculateRoutes();
            const bestRoute = routes[0];
            const baseline = routes.find(r => r.type === 'Direct') || routes[routes.length - 1];
            const diffAmount = bestRoute.finalAmount - baseline.finalAmount;
            const diffPercent = (diffAmount / baseline.finalAmount) * 100;

            const getRelevantPairs = () => {
                const relevant = new Set();
                const pairKey = (a, b) => rates[`${a}-${b}`] ? `${a}-${b}` : `${b}-${a}`;
                relevant.add(pairKey(sourceCurr, targetCurr));
                
                CURRENCIES.filter(c => c.code !== sourceCurr && c.code !== targetCurr).forEach(mid => {
                    relevant.add(pairKey(sourceCurr, mid.code));
                    relevant.add(pairKey(mid.code, targetCurr));
                });
                return Array.from(relevant);
            };

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 pt-20 font-sans text-slate-800">
                    <div className="max-w-5xl mx-auto">
                        <header className="mb-8 text-center">
                            <h1 className="text-3xl font-bold text-slate-800 mb-2 flex items-center justify-center gap-3">
                                <i className="ph-fill ph-globe text-blue-600 text-4xl"></i>
                                多幣別匯率套利分析
                            </h1>
                            <p className="text-slate-500">即時比較直接兌換與交叉匯率的最佳獲利路徑</p>
                        </header>

                        <div className="grid md:grid-cols-12 gap-6">
                            
                            {/* 左側：設定區 */}
                            <div className="md:col-span-5 space-y-6">
                                
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="mb-6">
                                        <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">交易金額</label>
                                        <input 
                                            type="number" 
                                            value={amount}
                                            onChange={(e) => setAmount(parseFloat(e.target.value) || 0)}
                                            className="w-full p-3 text-xl font-bold text-slate-700 bg-slate-100 rounded-xl border-none focus:ring-2 focus:ring-blue-500 outline-none"
                                        />
                                    </div>

                                    <div className="grid grid-cols-[1fr,auto,1fr] gap-2 items-center mb-6">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">持有</label>
                                            <select 
                                                value={sourceCurr}
                                                onChange={(e) => {
                                                    setSourceCurr(e.target.value);
                                                    if(e.target.value === targetCurr) setTargetCurr(sourceCurr);
                                                }}
                                                className="w-full p-3 font-bold bg-blue-50 text-blue-700 rounded-xl border-none cursor-pointer outline-none"
                                            >
                                                {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.name} ({c.code})</option>)}
                                            </select>
                                        </div>
                                        <i className="ph-bold ph-arrow-right text-slate-300 mt-6 text-xl"></i>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">目標</label>
                                            <select 
                                                value={targetCurr}
                                                onChange={(e) => {
                                                    setTargetCurr(e.target.value);
                                                    if(e.target.value === sourceCurr) setSourceCurr(targetCurr);
                                                }}
                                                className="w-full p-3 font-bold bg-emerald-50 text-emerald-700 rounded-xl border-none cursor-pointer outline-none"
                                            >
                                                {CURRENCIES.map(c => (
                                                    <option key={c.code} value={c.code} disabled={c.code === sourceCurr}>
                                                        {c.name} ({c.code})
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">手續費: {fee}%</label>
                                    <div className="flex items-center gap-3">
                                        <input 
                                            type="range" 
                                            min="0" 
                                            max="3" 
                                            step="0.1" 
                                            value={fee}
                                            onChange={(e) => setFee(parseFloat(e.target.value))}
                                            className="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                                        />
                                    </div>
                                </div>

                                {/* 匯率設定 */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 relative">
                                     <div className="flex items-center justify-between mb-4">
                                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                            <i className="ph-bold ph-calculator text-slate-400"></i>
                                            匯率設定
                                        </h3>
                                        <button 
                                            onClick={fetchLiveRates}
                                            disabled={isLoading}
                                            className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-medium transition-all ${
                                                isLoading ? 'bg-slate-100 text-slate-400' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'
                                            }`}
                                        >
                                            <i className={`ph-bold ph-arrows-clockwise ${isLoading ? 'animate-spin' : ''}`}></i>
                                            {isLoading ? '...' : '更新'}
                                        </button>
                                    </div>
                                    
                                    {lastUpdated && !apiError && (
                                        <div className="mb-4 text-[10px] text-slate-400 bg-slate-50 p-2 rounded flex justify-between items-center">
                                            <span>來源: ExchangeRate-API</span>
                                            <span>{lastUpdated}</span>
                                        </div>
                                    )}

                                    <div className="space-y-3 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                                        {getRelevantPairs().map(key => {
                                            const [base, quote] = key.split('-');
                                            return (
                                                <div key={key} className="bg-slate-50 p-3 rounded-xl border border-slate-200 focus-within:ring-2 focus-within:ring-blue-500 transition-all">
                                                    <label className="flex justify-between text-xs text-slate-500 mb-1">
                                                        <span>{base} → {quote}</span>
                                                        <span className="font-mono">1 {base} = ? {quote}</span>
                                                    </label>
                                                    <input 
                                                        type="number" 
                                                        value={rates[key]}
                                                        onChange={(e) => handleRateChange(key, e.target.value)}
                                                        className="w-full bg-transparent font-mono font-bold text-slate-700 outline-none"
                                                    />
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <p className="text-xs text-slate-400 mt-3 text-center">
                                        提示：手動修改上述數值以模擬真實銀行的匯差
                                    </p>
                                </div>
                            </div>

                            {/* 右側：結果區 */}
                            <div className="md:col-span-7 space-y-4">
                                
                                {/* 最佳建議 Banner */}
                                <div className="bg-gradient-to-br from-slate-800 to-slate-900 p-6 rounded-2xl shadow-xl text-white relative overflow-hidden">
                                    <div className="relative z-10">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="px-2 py-0.5 rounded text-xs font-bold bg-emerald-500 text-white uppercase tracking-wider">Best Option</span>
                                            <span className="text-slate-400 text-xs">最佳路徑建議</span>
                                        </div>
                                        <h2 className="text-2xl md:text-3xl font-bold mb-2">
                                            {bestRoute.type === 'Direct' 
                                                ? `直接用 ${sourceCurr} 兌換` 
                                                : `先換成 ${bestRoute.via} 再換 ${targetCurr}`}
                                        </h2>
                                        <p className="text-slate-300 text-sm">
                                            預計可獲得 <span className="text-emerald-400 font-mono text-xl font-bold ml-1">{bestRoute.finalAmount.toLocaleString(undefined, {maximumFractionDigits: 1})}</span> {targetCurr}
                                        </p>
                                        {diffPercent > 0.01 && (
                                            <div className="mt-3 text-xs bg-emerald-500/20 inline-block px-3 py-1 rounded-full border border-emerald-500/30 text-emerald-300">
                                                比最差路徑多賺 {diffPercent.toFixed(2)}% ({diffAmount.toLocaleString(undefined, {maximumFractionDigits: 0})} {targetCurr})
                                            </div>
                                        )}
                                    </div>
                                    <i className="ph-fill ph-coins absolute -right-6 -bottom-6 text-9xl text-white opacity-5"></i>
                                </div>

                                {/* 路徑列表 */}
                                <div className="space-y-3">
                                    <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider ml-1">路徑分析列表</h4>
                                    
                                    {routes.map((route, idx) => {
                                        const isBest = idx === 0;
                                        return (
                                            <div key={idx} className={`p-4 rounded-xl border-2 transition-all flex items-center justify-between ${
                                                isBest ? 'border-emerald-500 bg-emerald-50/50' : 'border-transparent bg-white shadow-sm opacity-80 hover:opacity-100'
                                            }`}>
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className={`text-xs font-bold uppercase px-2 py-0.5 rounded ${
                                                            route.type === 'Direct' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'
                                                        }`}>
                                                            {route.type === 'Direct' ? '直接兌換' : `轉兌 (${route.via})`}
                                                        </span>
                                                        {isBest && <span className="flex items-center gap-1 text-xs text-emerald-600 font-bold"><i className="ph-fill ph-check-circle"></i> 推薦</span>}
                                                    </div>
                                                    
                                                    <div className="flex items-center gap-2 text-sm font-bold text-slate-700 my-2">
                                                        {route.path.map((curr, i) => (
                                                            <React.Fragment key={i}>
                                                                {i > 0 && <i className="ph-bold ph-arrow-right text-slate-400"></i>}
                                                                <span>{curr}</span>
                                                            </React.Fragment>
                                                        ))}
                                                    </div>

                                                    {route.feeCount > 1 && fee > 0 && (
                                                        <div className="text-[10px] text-orange-500 flex items-center gap-1">
                                                            <i className="ph-bold ph-warning"></i> 兩次手續費 ({fee * 2}%)
                                                        </div>
                                                    )}
                                                </div>

                                                <div className="text-right">
                                                    <div className="text-2xl font-bold text-slate-800">
                                                        {route.finalAmount.toLocaleString(undefined, {maximumFractionDigits: 0})}
                                                        <span className="text-xs text-slate-400 font-normal ml-1">{targetCurr}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-400">
                                                        綜合匯率: {(route.finalAmount / amount).toFixed(4)}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                <div className="bg-white p-5 rounded-2xl shadow-sm text-slate-600 text-xs leading-relaxed flex gap-3">
                                    <i className="ph-fill ph-info text-blue-500 text-lg flex-shrink-0 mt-0.5"></i>
                                    <div>
                                        <p className="mb-2">
                                            <strong>分析說明：</strong> 此工具比較了 {routes.length} 種不同的兌換路徑。
                                            當您手上的貨幣是 <strong>{sourceCurr}</strong>，目標是獲得 <strong>{targetCurr}</strong> 時，
                                            系統會同時計算「直接買」以及「透過其他貨幣中轉」的結果。
                                        </p>
                                        <p>
                                            如果您看到轉兌路徑更划算，通常是因為中間貨幣（Intermediary Currency）對目標貨幣的匯率異常強勢。
                                            請務必將左側的匯率數字調整為您銀行櫃檯的「現金賣出價」以獲得精確結果。
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>